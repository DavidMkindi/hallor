{% extends "base.html" %}

{% block title %}{{ user.full_name }} (@{{ user.username }}) - Social Media App{% endblock %}

{% block content %}
<!-- Add profile-page class to body for CSS targeting -->
<script>
// Add profile-page class to body element immediately
document.body.classList.add('profile-page');
</script>

<div class="container-fluid p-0">
    <div class="row justify-content-center g-0">
        <!-- Main Content Area (Centered) -->
        <div class="col-12 col-lg-10 col-xl-8" id="main-content-area">
            <div class="p-0">
                <!-- Profile Header -->
                <div class="custom-bg px-3 px-md-4 pb-3">
                    <div class="d-flex flex-row align-items-center">
                        <!-- Avatar -->
                        <div class="position-relative mb-0" style="flex-shrink: 0;">
                            <img src="{{ url_for('serve_avatar', filename=(user.avatar|avatar_filename|default('avatar-1.jpg'))) }}" 
                                 alt="{{ user.username }}"
                                 class="rounded-circle border border-4 border-white shadow profile-header-avatar"
                                 style="object-fit: cover;">
                            {% if user.is_verified %}
                            <span class="position-absolute bottom-0 end-0 bg-primary rounded-circle p-1" style="width: 28px; height: 28px;">
                                <i class="bi bi-check-lg text-white" style="font-size: 0.875rem;"></i>
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- User Info -->
                        <div class="flex-grow-1 ms-2 ms-md-4" style="min-width: 0; overflow: visible; width: 0;">
                            <h4 class="mb-1 fw-bold text-body d-flex align-items-center flex-wrap">
                                {{ user.full_name }}
                                {% if user.is_verified %}
                                <i class="bi bi-patch-check-fill text-primary ms-2"></i>
                                {% endif %}
                            </h4>
                            <p class="text-body-secondary mb-2">@{{ user.username }}</p>
                            
                            <!-- Stats -->
                            <div class="d-flex mb-0 profile-stats-container" style="overflow: visible; gap: 1rem;">
                                <div class="profile-stats-item d-flex flex-column align-items-center">
                                    <span class="text-body-secondary small">posts</span>
                                    <span class="fw-bold text-body">{{ user.posts_count }}</span>
                                </div>
                                <div class="profile-stats-item d-flex flex-column align-items-center" style="cursor: pointer;">
                                    <span class="text-body-secondary small">followers</span>
                                    <span class="fw-bold text-body">{{ user.followers_count | format_number }}</span>
                                </div>
                                <div class="profile-stats-item d-flex flex-column align-items-center" style="cursor: pointer;">
                                    <span class="text-body-secondary small">following</span>
                                    <span class="fw-bold text-body">{{ user.following_count }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons - Desktop Only (Hidden on mobile/tablet) -->
                        <div class="d-none d-md-flex gap-2 flex-wrap" style="flex-shrink: 0; align-self: center;">
                            {% if is_own_profile %}
                                <button class="btn btn-outline-secondary">
                                    <i class="bi bi-pencil me-2"></i>Edit Profile
                                </button>
                                <button class="btn btn-outline-secondary">
                                    <i class="bi bi-gear"></i>
                                </button>
                            {% else %}
                                <button class="btn {% if user.is_following %}btn-outline-primary{% else %}btn-primary{% endif %} follow-btn" data-user-id="{{ user.id }}">
                                    <span class="follow-text">{% if user.is_following %}Following{% else %}Follow{% endif %}</span>
                                </button>
                                <button class="btn btn-outline-secondary message-btn" data-username="{{ user.username }}" data-user-id="{{ user.id }}">
                                    <i class="bi bi-chat"></i> Message
                                </button>
                                <button class="btn btn-outline-secondary">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Bio -->
                    <div class="mt-3">
                        <p class="mb-2 text-body">{{ user.bio }}</p>
                        {% if user.website %}
                        <p class="mb-1">
                            <i class="bi bi-link-45deg text-body-secondary me-1"></i>
                            <a href="{{ user.website }}" target="_blank" class="text-primary text-decoration-none">{{ user.website }}</a>
                        </p>
                        {% endif %}
                        {% if user.location %}
                        <p class="mb-1 text-body-secondary">
                            <i class="bi bi-geo-alt me-1"></i>{{ user.location }}
                        </p>
                        {% endif %}
                        <p class="mb-0 text-body-secondary small">
                            <i class="bi bi-calendar3 me-1"></i>Joined {{ user.joined_date }}
                        </p>
                    </div>
                    
                    <!-- Action Buttons - Mobile/Tablet Only (below bio) -->
                    <div class="d-flex gap-2 flex-wrap d-md-none mt-3">
                        {% if is_own_profile %}
                            <button class="btn btn-outline-secondary">
                                <i class="bi bi-pencil me-2"></i>Edit Profile
                            </button>
                            <button class="btn btn-outline-secondary">
                                <i class="bi bi-gear"></i>
                            </button>
                        {% else %}
                            <button class="btn {% if user.is_following %}btn-outline-primary{% else %}btn-primary{% endif %} follow-btn" data-user-id="{{ user.id }}">
                                <span id="follow-text">{% if user.is_following %}Following{% else %}Follow{% endif %}</span>
                            </button>
                            <button class="btn btn-outline-secondary message-btn" data-username="{{ user.username }}" data-user-id="{{ user.id }}">
                                <i class="bi bi-chat"></i> Message
                            </button>
                            <button class="btn btn-outline-secondary">
                                <i class="bi bi-three-dots"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Profile Tabs -->
                <div class="border-bottom">
                    <ul class="nav nav-tabs border-0 px-3 px-md-4" id="profileTabs" role="tablist" style="flex-wrap: nowrap; display: flex;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active border-0" id="posts-tab" data-bs-toggle="tab" 
                                    data-bs-target="#posts" type="button" role="tab">
                                <i class="bi bi-grid-3x3 me-2"></i>Posts
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link border-0" id="saved-tab" data-bs-toggle="tab" 
                                    data-bs-target="#saved" type="button" role="tab">
                                <i class="bi bi-bookmark me-2"></i>Saved
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link border-0" id="tagged-tab" data-bs-toggle="tab" 
                                    data-bs-target="#tagged" type="button" role="tab">
                                <i class="bi bi-person-square me-2"></i>Tagged
                            </button>
                        </li>
                    </ul>
                </div>
                
                <!-- Tab Content -->
                <div class="tab-content px-3 px-md-4 py-4" id="profileTabContent">
                    <!-- Posts Tab -->
                    <div class="tab-pane fade show active" id="posts" role="tabpanel">
                        <div class="row g-2">
                            {% if user_posts %}
                                {% for post in user_posts %}
                                <div class="col-4 col-md-3">
                                    <div class="position-relative profile-post-card" style="cursor: pointer;" data-post-id="{{ post.id }}">
                                        <img src="{{ url_for('serve_post_image', filename=post.image) }}" 
                                             class="img-fluid w-100 rounded" 
                                             alt="Post"
                                             style="aspect-ratio: 1; object-fit: cover;">
                                        
                                        <!-- Hover Overlay -->
                                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center profile-post-overlay rounded" 
                                             style="background: rgba(0,0,0,0); transition: background 0.3s;">
                                            <div class="text-white d-none">
                                                <div class="d-flex align-items-center gap-3">
                                                    <span><i class="bi bi-heart-fill me-2"></i>{{ post.likes_count }}</span>
                                                    <span><i class="bi bi-chat-fill me-2"></i>{{ post.comments_count }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <!-- Empty State -->
                                <div class="col-12 text-center py-5">
                                    <i class="bi bi-camera fs-1 text-body-secondary mb-3"></i>
                                    <h5 class="text-body-secondary">No posts yet</h5>
                                    {% if is_own_profile %}
                                    <p class="text-body-secondary">Share your first photo to get started!</p>
                                    <a href="/create" class="btn btn-primary mt-3">
                                        <i class="bi bi-plus-circle me-2"></i>Create Post
                                    </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Saved Tab -->
                    <div class="tab-pane fade" id="saved" role="tabpanel">
                        <div class="row g-2">
                            {% if saved_posts %}
                                {% for post in saved_posts %}
                                <div class="col-4 col-md-3">
                                    <div class="position-relative profile-post-card" style="cursor: pointer;">
                                        <img src="{{ url_for('serve_post_image', filename=post.image) }}" 
                                             class="img-fluid w-100 rounded" 
                                             alt="Post"
                                             style="aspect-ratio: 1; object-fit: cover;">
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <!-- Empty State -->
                                <div class="col-12 text-center py-5">
                                    <i class="bi bi-bookmark fs-1 text-body-secondary mb-3"></i>
                                    <h5 class="text-body-secondary">No saved posts</h5>
                                    <p class="text-body-secondary">Save posts to see them here later</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Tagged Tab -->
                    <div class="tab-pane fade" id="tagged" role="tabpanel">
                        <div class="text-center py-5">
                            <i class="bi bi-person-square fs-1 text-body-secondary mb-3"></i>
                            <h5 class="text-body-secondary">No tagged posts</h5>
                            <p class="text-body-secondary">Posts that @{{ user.username }} is tagged in will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Page Styles -->
<style>
.profile-post-card:hover .profile-post-overlay {
    background: rgba(0,0,0,0.5) !important;
}

.profile-post-card:hover .profile-post-overlay > div {
    display: flex !important;
}

.nav-tabs {
    flex-wrap: nowrap !important;
    display: flex !important;
}

.nav-tabs .nav-item {
    flex: 1 !important;
    flex-shrink: 0 !important;
    text-align: center !important;
}

.nav-tabs .nav-link {
    color: var(--bs-body-color);
    opacity: 0.6;
    width: 100% !important;
    justify-content: center !important;
}

.nav-tabs .nav-link.active {
    opacity: 1;
    border-bottom: 2px solid var(--bs-primary) !important;
}

.nav-tabs .nav-link:hover {
    opacity: 0.8;
}

/* Responsive avatar sizing */
.profile-header-avatar {
    width: 90px !important;
    height: 90px !important;
}

@media (min-width: 768px) {
    .profile-header-avatar {
        width: 120px !important;
        height: 120px !important;
    }
}

/* Ensure stats text is fully visible and stay in one row */
.profile-stats-item {
    flex-shrink: 0 !important;
    align-items: center !important;
    gap: 0.5rem !important;
    padding: 0.5rem 0.75rem !important;
    min-width: 60px !important;
}

.profile-stats-item span {
    display: block !important;
    line-height: 1.3 !important;
}

/* Responsive stats container - ensure it stays in one row */
.profile-stats-container {
    flex-wrap: nowrap !important;
    overflow-x: visible !important;
    min-width: 0 !important;
    width: 100% !important;
    justify-content: space-around !important;
}

@media (max-width: 767px) {
    .profile-stats-container {
        gap: 0.75rem !important;
        justify-content: space-between !important;
    }
    .profile-stats-item {
        padding: 0.5rem !important;
        flex: 1 !important;
        min-width: auto !important;
    }
}

@media (min-width: 768px) {
    .profile-stats-container {
        gap: 1.5rem !important;
        justify-content: flex-start !important;
    }
}
</style>

<!-- Profile Page Script -->
<script>
// Format number helper
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

document.addEventListener('DOMContentLoaded', function() {
    // Follow button functionality - handle both desktop and mobile buttons
    const followBtns = document.querySelectorAll('.follow-btn');
    followBtns.forEach(function(followBtn) {
        followBtn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const isFollowing = this.classList.contains('btn-outline-primary');
            
            // Update all follow buttons (desktop and mobile) to stay in sync
            followBtns.forEach(function(btn) {
                const followText = btn.querySelector('.follow-text');
                if (isFollowing) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-primary');
                    if (followText) followText.textContent = 'Follow';
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                    if (followText) followText.textContent = 'Following';
                }
            });
            
            // API call would go here
            console.log('Follow toggled for user:', userId);
        });
    });
    
    // Post click functionality
    document.querySelectorAll('.profile-post-card').forEach(card => {
        card.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            // Navigate to post detail or open modal
            console.log('Post clicked:', postId);
            // Could implement modal here similar to explore page
        });
    });
    
    // Message button functionality
    document.querySelectorAll('.message-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const username = this.getAttribute('data-username');
            if (!username) return;
            
            // Disable button while processing
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
            
            // Start conversation via API
            fetch(`/api/messages/start/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return null;
                    }
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to start conversation');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    // Redirect to messages page using encrypted token
                    // Use username_token for security (encrypted and time-limited)
                    if (data.username_token) {
                        window.location.href = `/messages?token=${encodeURIComponent(data.username_token)}`;
                    } else if (data.token) {
                        // Fallback to conversation token if username token not available
                        window.location.href = `/messages?conv_token=${encodeURIComponent(data.token)}`;
                    } else {
                        // Last resort: use username (less secure but functional)
                        window.location.href = `/messages?username=${username}`;
                    }
                }
            })
            .catch(error => {
                console.error('Error starting conversation:', error);
                alert('Failed to start conversation. Please try again.');
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
    });
});
</script>
{% endblock %}

